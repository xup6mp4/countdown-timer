<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>倒數計時器 ⏳（閃爍＋音效強化 v2）</title>

  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="倒數計時器" />
  <link rel="manifest" href="manifest.webmanifest?v=10" />
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png?v=3" />
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png?v=3" />
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png?v=3" />

  <style>
    :root { --bg:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --warning:#f59e0b; }
    html, body { height:100%; }
    body { margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial;
      background: radial-gradient(1200px 1200px at 80% -20%, #1f2937 0, var(--bg) 50%);
      color:var(--text); display:flex; justify-content:center; align-items:flex-start; padding:16px; min-height:100vh; overflow-x:hidden; }
    .card { width:min(700px,100vw); background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08);
      border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,.45); padding:24px 20px 18px; transform:scale(.9); transform-origin:center top; }
    .title h1 { font-size:22px; margin:0; } .subtitle{color:var(--muted); font-size:13px; margin-bottom:18px;}
    .display { user-select:none; display:flex; justify-content:center; align-items:center; font-size:clamp(96px,14vw,144px);
      padding:calc(80px - 0.25cm) 0; border-radius:24px; border:2px solid rgba(255,255,255,.2); background:rgba(255,255,255,.04); margin:8px 0 20px; }
    .display small{ font-size:.33em; color:var(--muted); margin-left:8px; }
    .grid{ display:grid; gap:12px; grid-template-columns:repeat(6,1fr); } .field{ grid-column:span 2; }
    .field label{ display:block; font-size:12px; color:var(--muted); margin:4px 0; }
    .field input[type="number"]{ width:100%; background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:12px; font-size:16px; outline:none; }
    .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    button{ appearance:none; border:1px solid rgba(255,255,255,.15); background:#0b1220; color:var(--text); padding:10px 14px; border-radius:12px; font-size:15px; cursor:pointer; transition:transform .02s ease, background .2s ease; }
    button:active{ transform:translateY(1px); }
    .primary{ background:linear-gradient(180deg,var(--accent),#16a34a); color:#041e0e; font-weight:700; }
    .outline{ border-color:rgba(255,255,255,.25); }
    .warn{ background:linear-gradient(180deg,var(--warning),#d97706); color:#2e1b00; border-color:rgba(0,0,0,.2); }
    #add{ flex:1 1 100%; width:100%; font-size:clamp(48px,7vw,72px); padding:calc(80px - 0.25cm) 0; border-radius:24px; box-shadow:0 12px 40px rgba(245,158,11,.5); font-weight:900; margin-top:22px; letter-spacing:1px; }
    #add:active{ transform:translateY(3px) scale(.98); }
    #flash{ position:fixed; inset:0; background:#fff; pointer-events:none; opacity:0; z-index:9999; }
    .flash #flash{ animation:flashBlink 1s ease-in-out 3; }
    @keyframes flashBlink{ 0%,100%{opacity:0} 50%{opacity:.9} }
    @media (prefers-reduced-motion: reduce){ .flash #flash{ animation-duration:.2s; animation-iteration-count:1; } }
  </style>
</head>
<body>
  <div id="flash"></div>
  <main class="card">
    <div class="title">
      <h1>倒數計時器</h1>
      <span class="subtitle">支援即時加時與快捷鍵</span>
    </div>
    <div id="screen" class="display">00:00<small id="ms">.0</small></div>
    <section class="grid">
      <div class="field"><label for="min">起始分鐘</label><input id="min" type="number" min="0" value="5" /></div>
      <div class="field"><label for="sec">起始秒數</label><input id="sec" type="number" min="0" max="59" value="0" /></div>
      <div class="field"><label for="inc">每次加時（秒）</label><input id="inc" type="number" min="1" value="60" /></div>
    </section>
    <div class="actions">
      <button id="startPause" class="primary">開始</button>
      <button id="reset" class="outline">重設</button>
      <button id="quick1m" class="outline">+1 分鐘</button>
      <button id="quick30s" class="outline">+30 秒</button>
    </div>
    <button id="add" class="warn">+ 加時</button>
  </main>

  <script>
    // === 音效：iPhone 可靠播放（WebAudio + <audio> 兩段式） ===
    let audioCtx = null;
    let unlocked = false;
    // 內建一個極短的 WAV 當後援（440Hz, 約 300ms）
    const FALLBACK_BEEP = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAAAAP///wAAAP///wAAAP7+/gAAAPn5+QAAAPX19QAAAPLy8gAAAPDw8AAAAPLy8gAAAPX19QAAAPn5+QAAAP7+/gAAAP///wAAAP///wAA";

    function getAudioCtx() {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return null;
      if (!audioCtx) audioCtx = new AC({latencyHint:'interactive'});
      return audioCtx;
    }

    function ensureAudioUnlocked() {
      const ctx = getAudioCtx();
      if (!ctx || unlocked) return;
      try {
        const buffer = ctx.createBuffer(1, 1, 22050);
        const src = ctx.createBufferSource();
        src.buffer = buffer;
        const gain = ctx.createGain();
        gain.gain.value = 0.00001;
        src.connect(gain).connect(ctx.destination);
        src.start(0);
        if (ctx.state === 'suspended') ctx.resume();
        unlocked = true;
      } catch (e) {}
    }

    // 更多事件嘗試解鎖（部分 iOS 只認特定事件）
    ['pointerdown','touchstart','mousedown','keydown'].forEach(evt => {
      window.addEventListener(evt, ensureAudioUnlocked, { once: true, passive: true });
    });

    function playBeep() {
      // 先試 WebAudio
      try {
        const ctx = getAudioCtx();
        if (ctx) {
          if (ctx.state === 'suspended') ctx.resume();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine'; o.frequency.value = 880; // 更清晰的頻率
          const t0 = ctx.currentTime;
          g.gain.setValueAtTime(0.0001, t0);
          g.gain.exponentialRampToValueAtTime(0.45, t0 + 0.02);  // 更大音量
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.70); // 更長尾巴
          o.connect(g).connect(ctx.destination);
          o.start(t0);
          o.stop(t0 + 0.72);
          return;
        }
      } catch (e) {}

      // 退而求其次：HTMLAudio（可能受靜音鍵與省電影響）
      try {
        const a = new Audio(FALLBACK_BEEP);
        a.play().catch(()=>{});
      } catch (e) {}
    }

    // === 倒數計時器核心 ===
    const screen = document.getElementById('screen');
    const msSmall = document.getElementById('ms');
    const startPauseBtn = document.getElementById('startPause');
    const resetBtn = document.getElementById('reset');
    const addBtn = document.getElementById('add');
    const quick1mBtn = document.getElementById('quick1m');
    const quick30sBtn = document.getElementById('quick30s');

    const minInput = document.getElementById('min');
    const secInput = document.getElementById('sec');
    const incInput = document.getElementById('inc');

    let running = false;
    let remainingMs = 0;
    let targetTs = 0;
    let rafId = null;
    let tickId = null;

    const LS_KEY = 'countdown_inc_seconds_v1';
    const savedInc = Number(localStorage.getItem(LS_KEY));
    if (!Number.isNaN(savedInc) && savedInc > 0) incInput.value = savedInc;

    function fmt(ms){ ms = Math.max(0, Math.floor(ms)); const totalSec = Math.floor(ms/1000); const m = Math.floor(totalSec/60); const s = totalSec % 60; const ds = Math.floor((ms % 1000)/100); return {m,s,ds}; }
    function render(ms){ const {m,s,ds} = fmt(ms); if (screen.firstChild) screen.removeChild(screen.firstChild); const txt = document.createTextNode(`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`); screen.insertBefore(txt, msSmall); msSmall.textContent = `.${ds}`; document.title = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')} ⏳`; }
    function readInitialMs(){ const m = Math.max(0, Number(minInput.value) || 0); const s = Math.max(0, Number(secInput.value) || 0); return (m*60 + s) * 1000; }
    function start(){ ensureAudioUnlocked(); if (running) return; if (remainingMs <= 0) remainingMs = readInitialMs(); if (remainingMs <= 0) { alert('請先設定起始時間'); return; } running = true; targetTs = performance.now() + remainingMs; startPauseBtn.textContent = '暫停'; scheduleTick(); loop(); }
    function pause(){ if (!running) return; running = false; remainingMs = Math.max(0, targetTs - performance.now()); startPauseBtn.textContent = '開始'; cancelLoop(); }
    function reset(){ running = false; remainingMs = readInitialMs(); startPauseBtn.textContent = '開始'; render(remainingMs); cancelLoop(); }
    function addSeconds(sec){ if (sec <= 0) return; if (sec === Number(incInput.value)) localStorage.setItem(LS_KEY, String(sec)); if (!running){ remainingMs = Math.max(0, (remainingMs || readInitialMs())) + sec*1000; render(remainingMs); return; } targetTs += sec*1000; }
    function scheduleTick(){ if (tickId) clearTimeout(tickId); const tick = () => { const left = Math.max(0, targetTs - performance.now()); render(left); if (left <= 0){ finish(); return; } tickId = setTimeout(tick, 100); }; tickId = setTimeout(tick, 0); }
    function loop(){ const step = () => { if (!running) return; const left = Math.max(0, targetTs - performance.now()); if (left <= 0){ finish(); return; } rafId = requestAnimationFrame(step); }; rafId = requestAnimationFrame(step); }
    function cancelLoop(){ if (rafId) cancelAnimationFrame(rafId), rafId = null; if (tickId) clearTimeout(tickId), tickId = null; }
    function flash(){ document.body.classList.add('flash'); setTimeout(() => document.body.classList.remove('flash'), 3005); }
    function finish(){ running = false; startPauseBtn.textContent = '開始'; render(0); playBeep(); flash(); cancelLoop(); }

    startPauseBtn.onclick = () => running ? pause() : start();
    resetBtn.onclick = reset;
    addBtn.onclick = () => addSeconds(Number(incInput.value || 0));
    quick1mBtn.onclick = () => addSeconds(60);
    quick30sBtn.onclick = () => addSeconds(30);
    [minInput, secInput].forEach(el => el.onchange = () => { if (!running){ remainingMs = readInitialMs(); render(remainingMs); }});
    window.onkeydown = e => { if (e.key === ' '){ e.preventDefault(); ensureAudioUnlocked(); running ? pause() : start(); } else if (e.key === '+' || e.key === '='){ addSeconds(Number(incInput.value || 0)); } else if (e.key.toLowerCase() === 'r'){ reset(); } };

    remainingMs = readInitialMs();
    render(remainingMs);

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(()=>{}); });
    }
  </script>
</body>
</html>