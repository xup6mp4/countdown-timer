<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>倒數計時器 ⏳（花費時間）</title>

  <!-- PWA (with v=4 cache-busting) -->
  <link rel="manifest" href="./manifest.webmanifest?v=4">
  <link rel="apple-touch-icon" href="icons/icon-180.png" sizes="180x180">
  <link rel="apple-touch-icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icons/icon-512.png" sizes="512x512">
  <meta name="theme-color" content="#0f172a">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js?v=4', { updateViaCache: 'none' });
      });
    }
  </script>

  <style>
    :root { --bg:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --warning:#f59e0b; }
    html, body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Helvetica Neue, Arial;
      background: radial-gradient(1200px 1200px at 80% -20%, #1f2937 0, var(--bg) 50%);
      color: var(--text);
      display: block;
      padding: calc(env(safe-area-inset-top) + 8px) 16px calc(env(safe-area-inset-bottom) + 16px) 16px;
      min-height: 100svh;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      overflow-x: hidden;
    }
    .card {
      width:min(700px,100vw);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      padding:8px 20px 18px;
      backdrop-filter:blur(6px);
      box-sizing:border-box;
      margin: 0 auto;
      max-width: 560px;
    }

    /* 倒數顯示框上下各縮小 1cm（更扁） */
    #screen.display { padding: calc(80px - 1.25cm) 0; }

    .display {
      user-select:none; display:flex; justify-content:center; align-items:center;
      font-size:clamp(96px,14vw,144px);
      padding:calc(80px - 0.25cm) 0;
      border-radius:24px; border:2px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.04); margin:8px 0 16px;
    }
    .display small { font-size:.4em; color:var(--muted); margin-left:2px; }

    /* 花費時間標題（鮮紅色） */
    .sw-heading { margin: 8px 0 6px; font-size: clamp(20px, 3vw, 24px); font-weight: 700; color: #ff2b2b; text-align: left; }

    .display-sw {
      font-size: clamp(28px, 5vw, 48px);
      padding: 16px 0;
      margin-top: 4px;
      background: rgba(255,255,255,.03);
      border: 2px dashed rgba(255,255,255,.18);
      color: #ffcc00;
      display:flex; justify-content:center; align-items:center;
    }
    .display-sw small { margin-left: 1px; } /* 正計時毫秒更貼近秒數 */

    .grid { display:grid; gap:12px; grid-template-columns:repeat(6, 1fr); }
    .field { grid-column:span 2; }
    .field label { display:block; font-size:12px; color:var(--muted); margin:4px 0; }
    .field input[type="number"] { width:100%; background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:12px; font-size:16px; outline:none; }

    .actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    button { appearance:none; border:1px solid rgba(255,255,255,.15); background:#0b1220; color:#e5e7eb; padding:10px 14px; border-radius:12px; font-size:15px; cursor:pointer; transition:transform .02s ease, background .2s ease; }
    button:active { transform:translateY(1px); }
    .primary { background:linear-gradient(180deg, var(--accent), #16a34a); border-color:rgba(0,0,0,.2); color:#041e0e; font-weight:700; }
    .outline { border-color:rgba(255,255,255,.25); }
    .warn { background:linear-gradient(180deg, var(--warning), #d97706); color:#2e1b00; border-color:rgba(0,0,0,.2); }

    /* +加時 按鈕上下各縮小 0.5cm（原本 -0.25cm，改為 -0.75cm） */
    #add { flex:1 1 100%; width:100%; font-size:clamp(48px,7vw,72px); padding: calc(80px - 0.75cm) 0; border-radius:24px; box-shadow:0 12px 40px rgba(245,158,11,.5); font-weight:900; margin-top:22px; letter-spacing:1px; }
    #add:active { transform: translateY(3px) scale(.98); }

    #flash { position:fixed; inset:0; background:#fff; pointer-events:none; opacity:0; z-index:9999; }
    .flash #flash { animation: flashBlink 1s ease-in-out 3; }
    @keyframes flashBlink { 0%,100%{opacity:0} 50%{opacity:.9} }

    * { box-sizing: border-box; }
    html, body { overflow-x: hidden; }
  </style>
</head>
<body>
  <div id="flash"></div>
  <main class="card">
    <div class="title" style="margin:0 0 4px 0;"><h1 style="margin:0;">倒數計時器</h1></div>

    <div id="screen" class="display">00:00<small id="ms">.0</small></div>
    <section class="grid">
      <div class="field"><label for="min">起始分鐘</label><input id="min" type="number" min="0" value="5" /></div>
      <div class="field"><label for="sec">起始秒數</label><input id="sec" type="number" min="0" max="59" value="0" /></div>
      <div class="field"><label for="inc">每次加時（秒）</label><input id="inc" type="number" min="1" value="60" /></div>
    </section>

    <div class="actions">
      <button id="startPause" class="primary">開始</button>
      <button id="reset" class="outline">重設</button>
      <button id="quick1m" class="outline">+1 分鐘</button>
      <button id="quick30s" class="outline">+30 秒</button>
    </div>

    <button id="add" class="warn">+ 加時</button>

    <div class="sw-heading">花費時間</div>
    <div id="swScreen" class="display display-sw">00:00<small id="swMs">.0</small></div>
  </main>

  <script>
    // DOM
    const screen = document.getElementById('screen'); const startPauseBtn = document.getElementById('startPause');
    const resetBtn = document.getElementById('reset'); const addBtn = document.getElementById('add');
    const quick1mBtn = document.getElementById('quick1m'); const quick30sBtn = document.getElementById('quick30s');
    const minInput = document.getElementById('min'); const secInput = document.getElementById('sec'); const incInput = document.getElementById('inc');
    const swScreen = document.getElementById('swScreen');

    // 狀態
    let running = false; let remainingMs = 0; let targetTs = 0; let rafId = null; let tickId = null;
    let swStartTs = 0; let swAccumMs = 0;

    // 格式化
    function fmt(ms){ ms = Math.max(0, Math.floor(ms)); const totalSec = Math.floor(ms/1000); const m = Math.floor(totalSec/60); const s = totalSec % 60; const ds = Math.floor((ms % 1000)/100); return {m,s,ds}; }
    function render(ms){ const {m,s,ds} = fmt(ms); screen.innerHTML = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}<small>.${ds}</small>`; }
    function renderSW(ms){ const {m,s,ds} = fmt(ms); swScreen.innerHTML = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}<small>.${ds}</small>`; }

    // 初值
    function readInitialMs(){ const m = Math.max(0, Number(minInput.value) || 0); const s = Math.max(0, Number(secInput.value) || 0); return (m*60 + s) * 1000; }

    // 控制
    function start(){ if (running) return; if (remainingMs <= 0) remainingMs = readInitialMs(); if (remainingMs <= 0) return; running = true; targetTs = performance.now() + remainingMs; swStartTs = performance.now(); startPauseBtn.textContent = '暫停'; tick(); loop(); }
    function pause(){ if (!running) return; running = false; remainingMs = Math.max(0, targetTs - performance.now()); swAccumMs += performance.now() - swStartTs; startPauseBtn.textContent = '開始'; cancel(); renderSW(swAccumMs); }
    function reset(){ running = false; remainingMs = readInitialMs(); render(remainingMs); swStartTs = 0; swAccumMs = 0; renderSW(0); startPauseBtn.textContent = '開始'; cancel(); }

    function addSeconds(sec){ if(sec<=0) return; if(!running){ remainingMs += sec*1000; render(remainingMs); } else { targetTs += sec*1000; } }
    quick1mBtn.onclick=()=>addSeconds(60);
    quick30sBtn.onclick=()=>addSeconds(30);
    addBtn.onclick=()=>addSeconds(Number(incInput.value)||60);

    // 計時迴圈
    function tick(){ if (tickId) clearTimeout(tickId); const t = ()=>{ const left = Math.max(0, targetTs - performance.now()); render(left); renderSW(running ? performance.now() - swStartTs + swAccumMs : swAccumMs); if (left <= 0) finish(); else tickId=setTimeout(t,100); }; t(); }
    function loop(){ const s=()=>{ if (!running) return; const left=Math.max(0,targetTs-performance.now()); if(left<=0) finish(); else rafId=requestAnimationFrame(s); }; rafId=requestAnimationFrame(s); }
    function cancel(){ if (rafId) cancelAnimationFrame(rafId); if (tickId) clearTimeout(tickId); }

    // 完成效果
    function flash(){ document.body.classList.add('flash'); setTimeout(()=>document.body.classList.remove('flash'),3000); }
    function finish(){ running=false; render(0); flash(); swAccumMs += performance.now()-swStartTs; renderSW(swAccumMs); startPauseBtn.textContent='開始'; cancel(); }

    // 綁定
    startPauseBtn.onclick=()=>running?pause():start();
    resetBtn.onclick=reset;
  </script>
</body>
</html>
